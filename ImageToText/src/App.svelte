<script>
	import Tesseract from 'tesseract.js';
	import { global } from 'svelte/internal';
	
	var image;
	var response = "";
	let defaultSpeed = 1; 	
	var language = "fr";
	var pauseOuDemarre = "stop";
	var isLoading = false; 

	function changeSpeed(speed) {
		window.speechSynthesis.cancel();
		defaultSpeed = speed;
		console.log(response); 
		textToVoice(response); 
	}
	

	function changeLang() {
		window.speechSynthesis.cancel();
		if (language == "fr") {
			language = "en-US";
		} 
		else {
			language = "fr";
		}
	}

	function pauseStart() {
		console.log(pauseOuDemarre);
		if (pauseOuDemarre == "stop") {
			window.speechSynthesis.pause();
			pauseOuDemarre = "start";
		}
		else {
			window.speechSynthesis.resume(); 
			pauseOuDemarre = "stop";
		}
	}

	function textToVoice(message) {
	window.speechSynthesis.cancel();
	if ('speechSynthesis' in window) {
		var msg = new SpeechSynthesisUtterance();
		var voices = window.speechSynthesis.getVoices();
		msg.lang = language; //fr en-US
		msg.voice = voices[10]; //4 fille 3 gars
		msg.volume = 1; // de 0 to 1
		msg.rate = defaultSpeed; // de 0.1 to 10
		msg.pitch = 1; // de 0 to 2
		msg.text = message;
		window.speechSynthesis.speak(msg);
	}

	else{console.log(' Speech Synthesis Not Supported'); }
	}

	let opencambutton = document.querySelector("#opencamera");
		let video = document.querySelector("#video");
		let takepicbutton = document.querySelector("#takepic");
		let canvas = document.querySelector("#canvas");
		
		opencambutton.addEventListener('click', async function() {
			   let stream = await navigator.mediaDevices.getUserMedia( {video: { 
				width: 1280 , 
				height: 720 }});
			video.srcObject = stream;
		});
		takepicbutton.addEventListener('click', function() {
			   canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
			    image = canvas.toDataURL('image/jpeg');
			
			   console.log(image)

	});	

	if (annyang) {
      // Let's define a command.
      const commands = {
    'start': () => { 
        logTesseract();
        },
    'pause':() =>{
        window.speechSynthesis.pause();
    },
    'resume':() =>{
        window.speechSynthesis.resume();
    }
    };

      // Add our commands to annyang
      annyang.addCommands(commands);

  // Start listening.
      annyang.start();
        }

	/*
	 * Function to detect text in the image 
	*/
	function logTesseract() {
		isLoading = true; 
		Tesseract.recognize(
			image,
			'eng',
			{logger: m => console.log(m)}
		).then(({data: { text }}) => {
			response = text; 
			isLoading = false; 
			textToVoice(response); 
		})
	}

</script>

<main>
	<h2>
		{#if isLoading == true}
		Loading...
		{/if}
	</h2>
	<button on:click={pauseStart}>Pause/Start</button>
	<button on:click={() => changeSpeed(5)}>Read Faster</button>
	<button on:click={() => changeSpeed(1)}>Normal speed</button>
	<button on:click={changeLang}>
		{#if language == "fr"}
		French
		{:else}
		English
		{/if}
	</button>
	<button on:click={logTesseract}>Read Image!</button>
	<p>Your text is: </p>
	<p>{response}</p>
</main>

<style>
	main {
		text-align: center;
		padding: 1em;
		max-width: 240px;
		margin: 0 auto;
	}

	h1 {
		color: #ff3e00;
		text-transform: uppercase;
		font-size: 4em;
		font-weight: 100;
	}

	@media (min-width: 640px) {
		main {
			max-width: none;
		}
	}
</style>
